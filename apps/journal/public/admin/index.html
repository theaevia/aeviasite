<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <!-- Provide Identity API URL when hosted off Netlify -->
    <script src="/identity-config.js"></script>
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <!-- Initialize Netlify Identity BEFORE Decap CMS loads -->
    <script>
      (function initIdentity(){
        function ready(){
          if (!window.netlifyIdentity) { return void setTimeout(ready, 50); }
          try {
            var url = window.NETLIFY_IDENTITY_URL;
            if (url) window.netlifyIdentity.init({ APIUrl: url });
            else window.netlifyIdentity.init();
          } catch(e) {}
        }
        ready();
      })();
    </script>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- CMS customizations: Figure editor component + post preview -->
    <script>
      (function registerCmsEnhancements(){
        function ready(){
          if (!window.CMS) return setTimeout(ready, 50);
          var CMS = window.CMS;

          // Figure editor component (inserts an MDX tag <Figure />)
          CMS.registerEditorComponent({
            id: 'figure',
            label: 'Figure',
            fields: [
              { name: 'src', label: 'Image', widget: 'image' },
              { name: 'alt', label: 'Alt text', widget: 'string' },
              { name: 'caption', label: 'Caption', widget: 'string', required: false },
              { name: 'size', label: 'Size', widget: 'select', options: ['small','normal','wide','full'], default: 'normal' },
              { name: 'align', label: 'Align', widget: 'select', options: ['left','center'], default: 'center' },
            ],
            pattern: /<Figure\s+([^>]*)\/?>(?:\s*<\/Figure>)?/,
            fromBlock: function(match){
              var attrs = match && match[1] ? match[1] : '';
              var obj = {};
              attrs.replace(/(\w+)=["']([^"']+)["']/g, function(_, k, v){ obj[k] = v; return ''; });
              return obj;
            },
            toBlock: function(obj){
              var parts = [];
              if (obj.src) parts.push(`src="${obj.src}"`);
              if (obj.alt) parts.push(`alt="${obj.alt}"`);
              if (obj.caption) parts.push(`caption="${obj.caption}"`);
              if (obj.size) parts.push(`size="${obj.size}"`);
              if (obj.align) parts.push(`align="${obj.align}"`);
              return `<Figure ${parts.join(' ')} />`;
            },
            toPreview: function(obj){
              var size = obj.size || 'normal';
              var align = obj.align || 'center';
              var cap = obj.caption ? `<figcaption>${obj.caption}</figcaption>` : '';
              return `<figure class="fig fig--${size} fig--${align}"><img src="${obj.src || ''}" alt="${obj.alt || ''}"/>${cap}</figure>`;
            }
          });

          // Simple post preview template for the editor preview pane
          var PostPreview = createClass({
            render: function(){
              var entry = this.props.entry;
              var title = entry.getIn(['data','title']);
              var dek = entry.getIn(['data','dek']);
              var hero = entry.getIn(['data','hero','src']);
              var alt = entry.getIn(['data','hero','alt']);
              var body = this.props.widgetFor('body');
              return h('div', { className: 'preview-container' },
                hero ? h('figure', { className: 'fig fig--normal fig--center' },
                  h('img', { src: hero, alt: alt || '' })
                ) : null,
                h('h1', { style: { fontFamily: 'Playfair Display,serif' } }, title),
                dek ? h('p', { style: { opacity: .75 } }, dek) : null,
                h('div', { className: 'prose' }, body)
              );
            }
          });
          CMS.registerPreviewTemplate('posts', PostPreview);

          // Light preview styles
          var css = `.preview-container{padding:20px;max-width:900px;margin:0 auto}`;
          CMS.registerPreviewStyle(`data:text/css,${encodeURIComponent(css)}`);
        }
        ready();
      })();
    </script>
  </body>
  
</html>

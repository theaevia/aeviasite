---
import BaseLayout from '../layouts/BaseLayout.astro';
import ShareBar from '../components/ShareBar.jsx';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.status === 'published');
  return posts.map((post) => ({ params: { slug: post.slug }, props: { post } }));
}

const { post } = Astro.props;

const authorsMap = Object.fromEntries(
  (await getCollection('authors')).map((a) => [a.data.slug, a.data])
);

const title = post.data.title;
const description = post.data.dek ?? '';
const og = post.data.og_image ?? post.data.hero?.src;
const datePublished = post.data.date;
const dateModified = post.data.updated ?? datePublished;
const authorObjs = post.data.authors.map((s) => authorsMap[s]).filter(Boolean);

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: title,
  datePublished,
  dateModified,
  author: authorObjs.map((a) => ({ '@type': 'Person', name: a.name, jobTitle: a.credentials })),
  image: og,
  publisher: { '@type': 'Organization', name: 'The Aevia Group LTD' },
  mainEntityOfPage: Astro.url.href,
};
const { Content } = await post.render();
---
<BaseLayout title={title} description={description} ogImage={og}>
  <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>
  <article class="space-y-6">
    <header class="space-y-2">
      <h1 class="text-4xl font-serif font-bold">{title}</h1>
      {description && <p class="text-foreground/70">{description}</p>}
      <p class="text-sm text-foreground/60">
        {authorObjs.map((a) => (
          <>
            {a.avatar && (
              <img src={a.avatar} alt={a.name} width="28" height="28" style="border-radius:50%;vertical-align:middle;margin-right:8px;" />
            )}
            <a class="underline underline-offset-2 hover:text-primary" href={`/journal/author/${a.slug}`}>{a.name}</a>{a.credentials ? `, ${a.credentials}` : ''}&nbsp;&middot;&nbsp;
          </>
        ))}
        <time datetime={datePublished}>{new Date(datePublished).toLocaleDateString('en-GB')}</time>
      </p>
    </header>

    <ShareBar client:load title={title} />

    <section class="prose prose-neutral max-w-none">
      <Content />
    </section>

    {post.data.disclaimer && (
      <aside class="text-sm text-foreground/70 border-l-4 border-primary pl-4"><strong>Disclaimer:</strong> {post.data.disclaimer}</aside>
    )}
  </article>

  <nav class="mt-8">
    <a class="inline-block rounded-md bg-primary text-white px-4 py-2 hover:bg-primary/90 smooth-transition" href="/consultations">Book a medical consultation</a>
  </nav>
</BaseLayout>
